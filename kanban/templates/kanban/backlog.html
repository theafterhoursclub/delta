{% extends "internal_base.html" %}
{%  load static %}
{# Remove the extra <!DOCTYPE html>, <html>, <head>, <body> if using extends. Only define blocks. #}
{% block internal %}

    <h1>All Tasks</h1>
    <div id="myGrid" style="width: 100%; height: 90%"></div>

    <script src="{% static 'sortable/sortable.min.js' %}"></script>
    <script src="{% static 'ag-grid/ag-grid-community.min.noStyle.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // AG-GRID INITIALIZATION
            if (typeof agGrid !== "undefined" && document.querySelector("#myGrid")) {
                const editTaskUrlPrefix = "/backlog/";

                const gridOptions = {
                    rowData: [
                        {% for task in tasks %}
                        {
                            id : "{{task.id}}",
                            title: "{{ task.title }}",
                            desc: "{{ task.description | striptags  | escapejs }}",
                            status: "{{ task.get_status_display }}",
                            due_date: "{{ task.due_date }}",
                            linked_story: "{{ task.linked_story }}",
                        },
                        {% endfor %}
                    ],
                    columnDefs: [
                        {
                            headerName: "",
                            width: 30,
                            minWidth: 20,
                            maxWidth: 40,
                            rowDrag: true,
                            suppressMenu: true,
                            sortable: false,
                            filter: false
                        },
                        { field: "id", headerName: "ID", maxWidth: 20 },
                        { field: "title", headerName: "Title", filter: 'agTextColumnFilter' },
                        { field: "desc", headerName: "Description", filter: 'agTextColumnFilter'  },
                        { field: "status", headerName: "Status", filter: 'agTextColumnFilter'  },
                        { field: "due_date", headerName: "Due Date" },
                        { field: "linked_story", headerName: "Linked Story", filter: 'agTextColumnFilter'  },
                        {
                            headerName: "Actions",
                            field: "id",
                            cellRenderer: function(params) {
                                const url = editTaskUrlPrefix + params.value + "/edit/";
                                return `<a href="${url}" class="btn btn-sm btn-primary">View</a>`;
                            },
                            width: 120,
                            suppressMenu: true,
                            sortable: false,
                            filter: false
                        }
                    ],
                    defaultColDef: {
                        flex: 1,
                    },
                    rowDragManaged: true,
                    animateRows: true,
                    onRowDragEnd: function(event) {
                        // Collect new order of task IDs
                        const rowOrder = [];
                        event.api.forEachNode(function(node) {
                            rowOrder.push(node.data.id);
                        });
                        // Send the new order to reorder_list_tasks endpoint
                        fetch("{% url 'reorder_list_tasks' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({ordered_ids: rowOrder})
                        }).then(response => {
                            if (!response.ok) {
                                alert('Failed to save new order.');
                            }
                        });
                    }
                };
                agGrid.createGrid(document.querySelector("#myGrid"), gridOptions);
            } else {
                console.error("agGrid not loaded or #myGrid not found!");
            }
        });
    </script>
{% endblock %}

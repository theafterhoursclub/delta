{% extends "base.html" %}
{% load kanban_extras %}
{% block content %}
<h1 class="mb-4">Kanban Board</h1>
<div class="row">
    {% for status in statuses %}
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header text-center text-uppercase fw-bold bg-light">
                {{ title }}
            </div>
            <div class="card-body p-2" style="min-height: 200px;">
                <div id="column-{{ status }}" class="kanban-column" data-status="{{ status }}">
                    {% for task in tasks_by_status|dict_get:status %}
                    <div class="card mb-3 kanban-task-card" data-task-id="{{ task.id }}">
                        <div class="card-body p-2">
                            <h5 class="card-title mb-1">{{ task.title }}</h5>
                            <p class="card-text mb-1">{{ task.description }}</p>
                            {% if task.due_date %}
                            <div class="text-muted small">Due: {{ task.due_date }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-muted small text-center no-tasks-msg">No tasks</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Use the actual statuses from the DOM, not a static list
    const statuses = Array.from(document.querySelectorAll('.kanban-column')).map(col => col.dataset.status);

    function updateNoTasksMessages() {
        statuses.forEach(function(status) {
            const column = document.getElementById('column-' + status);
            const cards = column.querySelectorAll('.kanban-task-card');
            let noTasksMsg = column.querySelector('.no-tasks-msg');
            if (cards.length === 0) {
                if (!noTasksMsg) {
                    noTasksMsg = document.createElement('div');
                    noTasksMsg.className = 'text-muted small text-center no-tasks-msg';
                    noTasksMsg.textContent = 'No tasks';
                    column.appendChild(noTasksMsg);
                }
            } else {
                if (noTasksMsg) {
                    noTasksMsg.remove();
                }
            }
        });
    }

    statuses.forEach(function(status) {
        new Sortable(document.getElementById('column-' + status), {
            group: 'kanban',
            animation: 150,
            onEnd: function (evt) {
                // Get the new status and ordered ids after move
                const newStatus = evt.to.dataset.status;
                const list = evt.to;
                const ordered_ids = Array.from(list.querySelectorAll('[data-task-id]')).map(card => card.getAttribute('data-task-id'));
                fetch("{% url 'reorder_tasks' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        ordered_ids: ordered_ids
                    })
                });
                // Update "No tasks" messages after move
                setTimeout(updateNoTasksMessages, 0);
            }
        });
    });

    // Initial update for "No tasks" messages
    updateNoTasksMessages();
});
</script>
{% endblock %}
